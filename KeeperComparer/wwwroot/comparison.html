<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparison Detail</title>
    <!-- Re-using the same CSS styles -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 20px auto;
            padding: 0 10px;
        }

        h1, h2 {
            color: #1a1a1a;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        a {
            color: #007bff;
            text-decoration: none;
        }

            a:hover {
                text-decoration: underline;
            }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

            .panel h3 {
                margin-top: 0;
            }

            .panel p {
                margin: 5px 0;
            }

            .panel strong {
                color: #555;
            }

        button {
            display: block;
            width: 100%;
            padding: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

            button:disabled {
                background-color: #a0a0a0;
                cursor: not-allowed;
            }

        #results {
            margin-top: 20px;
        }

        #overallResult {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

            .result-table th, .result-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
                word-break: break-word;
            }

            .result-table th {
                background-color: #f2f2f2;
            }

        .status-Exact, .status-ExactMatch {
            background-color: #d4edda;
            color: #155724;
        }

        .status-Strong {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-Partial, .status-SimilarMatch {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-Weak {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .status-Mismatch, .status-NoMatch {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-OneIsEmpty {
            background-color: #f0f0f0;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Comparison Detail</h1>
    <p><a href="/index.html">← Back to All Records</a></p>

    <div class="container">
        <div class="panel" id="recordADetail"><h3>Record from Source A</h3></div>
        <div class="panel" id="recordBDetail"><h3>Record from Source B</h3></div>
    </div>

    <button id="compareBtn" disabled>Compare Records</button>

    <div id="results"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const recordADiv = document.getElementById('recordADetail');
            const recordBDiv = document.getElementById('recordBDetail');
            const compareBtn = document.getElementById('compareBtn');
            const resultsDiv = document.getElementById('results');

            let recordA = null;
            let recordB = null;

            async function initialize() {
                const params = new URLSearchParams(window.location.search);
                const recordId = params.get('id');

                if (!recordId) {
                    document.body.innerHTML = '<h1>Error: No Record ID specified.</h1><a href="/index.html">Go Back</a>';
                    return;
                }

                const response = await fetch(`/api/records/${recordId}`);
                if (!response.ok) {
                    document.body.innerHTML = `<h1>Error: Could not find record with ID ${recordId}.</h1><a href="/index.html">Go Back</a>`;
                    return;
                }

                const data = await response.json();
                recordA = data.recordA;
                recordB = data.recordB;

                renderRecordCard(recordA, recordADiv, "Source A");
                renderRecordCard(recordB, recordBDiv, "Source B");

                if (recordA && recordB) {
                    compareBtn.disabled = false;
                } else {
                    compareBtn.textContent = "Cannot Compare (One Record Missing)";
                }
            }

            function renderRecordCard(record, element, sourceName) {
                if (!record) {
                    element.innerHTML += '<p style="color: red;">Record not found in this source.</p>';
                    return;
                }
                let address = record.address || {};
                element.innerHTML += `
                        <p><strong>ID:</strong> ${record.id}</p>
                        <p><strong>Name:</strong> ${record.fullName || 'N/A'}</p>
                        <p><strong>Email:</strong> ${record.emailAddress || 'N/A'}</p>
                        <p><strong>DOB:</strong> ${new Date(record.dateOfBirth).toLocaleDateString()}</p>
                        <p><strong>Mobile:</strong> ${record.mobileNumber || 'N/A'}</p>
                        <p><strong>Address:</strong> ${address.line1 || ''}, ${address.city || ''}, ${address.postcode || ''}</p>
                    `;
            }

            compareBtn.addEventListener('click', async () => {
                const recordToCompareA = recordA || {};
                const recordToCompareB = recordB || {};

                const response = await fetch('/comparison/compare', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([recordToCompareA, recordToCompareB])
                });

                if (response.ok) {
                    const resultData = await response.json();
                    renderResults(resultData);
                } else {
                    resultsDiv.innerHTML = `<p style="color: red;">An error occurred during comparison.</p>`;
                }
            });

            function renderResults(data) {
                let html = `<h2>Comparison Result</h2>`;
                html += `<div id="overallResult" class="status-${data.overallResult}">${data.overallResult}</div>`;
                html += `<table class="result-table">`;
                html += `<tr><th>Field Name</th><th>Value A</th><th>Value B</th><th>Status</th></tr>`;
                data.fieldResults.forEach(field => {
                    html += `<tr class="status-${field.status}"><td>${field.fieldName}</td><td>${field.valueA}</td><td>${field.valueB}</td><td>${field.status} ${field.similarityScore ? `(${(field.similarityScore * 100).toFixed(0)}%)` : ''}</td></tr>`;
                });
                html += `</table>`;
                resultsDiv.innerHTML = html;
            }

            initialize();
        });
    </script>
</body>
</html>